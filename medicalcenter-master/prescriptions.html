<!doctype html>
<html class="no-js" lang="zxx">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title> My Prescriptions - MediVerse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/fontawesome-all.min.css">
</head>

<body>
    <header>
        <div class="header-area">
            <div class="main-header header-sticky">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-xl-2 col-lg-2 col-md-1">
                            <div class="logo">
                                <a href="index.html"><img src="assets/img/logo/logo.png" alt=""></a>
                            </div>
                        </div>
                        <div class="col-xl-10 col-lg-10 col-md-10">
                            <div class="menu-main d-flex align-items-center justify-content-end">
                                <div class="main-menu f-right d-none d-lg-block">
                                    <nav>
                                        <ul id="navigation">
                                            <li><a href="index.html">Dashboard</a></li>
                                            <li><a href="appointments.html">Appointments</a></li>
                                            <li><a href="prescriptions.html">Prescriptions</a></li>
                                            <li><a href="medicine.html">Medicine</a></li>
                                            <li><a href="organs.html">Organs</a></li>
                                            <li><a href="#" onclick="logout()">Logout</a></li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="slider-area2">
            <div class="slider-height2 d-flex align-items-center">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="hero-cap hero-cap2 text-center">
                                <h2>My Digital Prescriptions</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="contact-section">
            <div class="container">
                <div class="row">
                    <!-- Left: Add New (Digitize) -->
                    <div class="col-lg-4">
                        <div style="background: #e3f2fd; padding: 30px; border-radius: 10px;">
                            <h3 style="color: #0a4dbf; margin-bottom: 20px;">‚ûï Add New Record</h3>
                            <form onsubmit="addPrescription(event)">
                                <div class="form-group">
                                    <label>Doctor Name</label>
                                    <input class="form-control" type="text" id="doc-name" placeholder="Dr. Smith"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Hospital / Clinic</label>
                                    <input class="form-control" type="text" id="hospital-name"
                                        placeholder="City Clinic">
                                </div>
                                <div class="form-group">
                                    <label>Diagnosis</label>
                                    <input class="form-control" type="text" id="diagnosis" placeholder="Viral Fever"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input class="form-control" type="date" id="visit-date" required>
                                </div>

                                <hr>
                                <h5 style="color: #0a4dbf;">Medicines</h5>
                                <div id="med-inputs">
                                    <div class="med-row mb-2">
                                        <input class="form-control mb-1" type="text"
                                            placeholder="Medicine Name (e.g. Paracetamol)" required>
                                        <div class="d-flex gap-2">
                                            <input class="form-control" type="text" placeholder="Dosage (500mg)"
                                                required>
                                            <input class="form-control" type="text" placeholder="Freq (1-0-1)" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addMedRow()" class="btn btn-sm btn-secondary mb-3">+ Add
                                    Another Med</button>

                                <div class="form-group">
                                    <label>Doctor's Advice / Notes</label>
                                    <textarea class="form-control" id="notes" rows="3"
                                        placeholder="Drink plenty of water..."></textarea>
                                </div>

                                <button type="submit" class="button boxed-btn w-100">Save Record</button>
                            </form>
                        </div>
                    </div>

                    <!-- Right: History List -->
                    <div class="col-lg-8">
                        <h3 class="mb-30" style="color: #0a4dbf;">üìú History</h3>
                        <div id="prescription-list">
                            <p>Loading records...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = "http://localhost:5000/api";
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if (!currentUser) window.location.href = "login.html";

        function logout() { localStorage.removeItem("user"); window.location.href = "login.html"; }

        // --- DYNAMIC FORM LOGIC ---
        function addMedRow() {
            const div = document.createElement("div");
            div.className = "med-row mb-2 border-top pt-2";
            div.innerHTML = `
                <input class="form-control mb-1" type="text" placeholder="Medicine Name" required>
                <div class="d-flex gap-2">
                    <input class="form-control" type="text" placeholder="Dosage" required>
                    <input class="form-control" type="text" placeholder="Freq (1-0-1)" required>
                </div>
            `;
            document.getElementById("med-inputs").appendChild(div);
        }

        // --- API LOGIC ---
        async function loadPrescriptions() {
            const listDiv = document.getElementById("prescription-list");
            try {
                const res = await fetch(`${API_URL}/prescriptions/${currentUser._id}`);
                const data = await res.json();

                listDiv.innerHTML = "";
                if (data.length === 0) {
                    listDiv.innerHTML = "<div class='alert alert-info'>No prescriptions found. Add your first digital record!</div>";
                    return;
                }

                data.forEach(p => {
                    const dateStr = new Date(p.date).toDateString();

                    let medsHtml = `<ul style="list-style: disk; padding-left: 20px;">`;
                    p.medicines.forEach(m => {
                        medsHtml += `<li><b>${m.name}</b> - ${m.dosage} (${m.frequency})</li>`;
                    });
                    medsHtml += `</ul>`;

                    const html = `
                        <div style="background: white; border: 1px solid #ddd; border-left: 5px solid #0a4dbf; padding: 20px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div class="d-flex justify-content-between">
                                <h4 style="color:#0a4dbf;">${p.hospitalName}</h4>
                                <small style="color: grey;">${dateStr}</small>
                            </div>
                            <h5>üë®‚Äç‚öïÔ∏è ${p.doctorName} <span class="badge badge-info">${p.diagnosis}</span></h5>
                            <hr>
                            <h6 style="color: #555;">Prescribed Medicines:</h6>
                            ${medsHtml}
                            ${p.notes ? `<p style="background:#f9f9f9; padding:10px; font-style:italic; margin-top:10px;">üìù Note: ${p.notes}</p>` : ''}
                        </div>
                    `;
                    listDiv.innerHTML += html;
                });

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = "<p style='color:red'>Failed to load history.</p>";
            }
        }

        async function addPrescription(e) {
            e.preventDefault();

            // Gather Medicines
            const medRows = document.querySelectorAll("#med-inputs .med-row");
            const medicines = [];
            medRows.forEach(row => {
                const inputs = row.querySelectorAll("input");
                medicines.push({
                    name: inputs[0].value,
                    dosage: inputs[1].value,
                    frequency: inputs[2].value,
                    duration: "N/A" // Simplified for now
                });
            });

            const data = {
                userId: currentUser._id,
                doctorName: document.getElementById("doc-name").value,
                hospitalName: document.getElementById("hospital-name").value,
                diagnosis: document.getElementById("diagnosis").value,
                date: document.getElementById("visit-date").value,
                notes: document.getElementById("notes").value,
                medicines: medicines
            };

            try {
                const res = await fetch(`${API_URL}/prescriptions`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    e.target.reset();
                    document.getElementById("med-inputs").innerHTML = `
                         <div class="med-row mb-2">
                            <input class="form-control mb-1" type="text" placeholder="Medicine Name (e.g. Paracetamol)" required>
                            <div class="d-flex gap-2">
                                <input class="form-control" type="text" placeholder="Dosage (500mg)" required>
                                <input class="form-control" type="text" placeholder="Freq (1-0-1)" required>
                            </div>
                        </div>
                    `; // Reset to 1 row
                    loadPrescriptions();
                    alert("‚úÖ Prescription Saved!");
                }
            } catch (err) {
                console.error(err);
                alert("Error saving.");
            }
        }

        // Init
        loadPrescriptions();
    </script>
</body>

</html>